@model FuNews.Modals.DTOs.Request.ReportRequest.ReportRequestModel

@{
    ViewData["Title"] = "Article Report";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4">
    <h2 class="mb-4 text-primary">📊 Article Report</h2>

    <form method="get" asp-action="ArticleReport" class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" name="startDate" class="form-control" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" name="endDate" class="form-control" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Group By</label>
            <select name="groupBy" class="form-select">
                <option value="">-- Select --</option>
                <option value="day" selected="@(Model.GroupBy == "day" ? "selected" : null)">Day</option>
                <option value="month" selected="@(Model.GroupBy == "month" ? "selected" : null)">Month</option>
                <option value="year" selected="@(Model.GroupBy == "year" ? "selected" : null)">Year</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">Generate Report</button>
        </div>
    </form>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger mt-3">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <p>@error.ErrorMessage</p>
            }
        </div>
    }

    @if (Model.ReportItems != null && Model.ReportItems.Any())
    {
        <div class="mt-5">
            <h4 class="mb-3 text-info">📋 Report Results</h4>
            <table class="table table-bordered table-striped shadow">
                <thead class="table-light">
                    <tr>
                        <th>Group</th>
                        <th>Article Count</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.ReportItems)
                    {
                        <tr>
                            <td>@item.Label</td>
                            <td>@item.count</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-5">
            <h4 class="mb-3 text-info">📈 Report Chart</h4>
            <canvas id="reportChart" height="100"></canvas>
        </div>

        <script>
            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReportItems.Select(i => i.Label)));
            const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReportItems.Select(i => i.count)));

            const ctx = document.getElementById('reportChart').getContext('2d');
            const reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Articles',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        </script>
    }
    else if (Model.ReportItems != null && !Model.ReportItems.Any())
    {
        <div class="alert alert-warning mt-5">
            ⚠️ There is no data to display for the selected date range and grouping option.
        </div>
    }
</div>
